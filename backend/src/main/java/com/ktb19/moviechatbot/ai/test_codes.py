import sys
import os
import json

#%%
os.chdir('backend/src/main/java/com/ktb19/moviechatbot/ai')
sys.path.append(os.getcwd())
#%%
from main import vectorize_documents, process_documents_and_question, generate_response,query_reprocess
#from embeddings import KoBERTEmbeddings
#%%
# 사용 예시
# documents = [
# "데드풀과 울버린",
# "늘봄가든",
# "빅토리",
# "세븐틴 투어 ‘팔로우’ 어게인 투 시네마",
# "명탐정 코난: 100만 달러의 펜타그램",
# "2023 심규선 단독 콘서트 : 우리 앞의 세계",
# "에이리언: 로물루스",
# "토끼는 어디로 갔나요?",
# "쥬라기캅스 극장판: 전설의 고대생물을 찾아라",
# "행복의 나라",
# "트위스터스",
# "슈퍼배드 4",
# "이준호 콘서트 : 다시 만나는 날",
# "사랑의 하츄핑",
# "우마무스메 프리티 더비 새로운 시대의 문",
# "하이퍼포커스 : 투모로우바이투게더 브이알 콘서트",
# "베베핀 플레이타임",
# "바다 탐험대 옥토넛 어보브 앤 비욘드 : 바다가 위험해",
# "이매지너리",
# "탈주",
# "2023 영탁 단독 콘서트 : 탁쇼2",
# "헬로카봇 올스타 스페셜",
# "탈출: 프로젝트 사일런스",
# "극장총집편 봇치 더 록! 전편",
# "플라이 미 투 더 문",
# "볼빨간사춘기: 메리 고 라운드 더 무비",
# "블랙핑크 월드투어 [본 핑크] 인 시네마",
# "이솝이야기",
# "박정희: 경제대국을 꿈꾼 남자",
# "극장판 도라에몽: 진구의 지구 교향곡",
# "2024 박은빈 팬 콘서트 <은빈노트 : 디바>",
# "민요 첼로",
# "다큐 황은정 : 스마트폰이 뭐길래"
# ]
#%%
# embeddings_model = KoBERTEmbeddings()
# vectorize_documents(documents,embeddings_model,'KoBERT_vector_store','jamodict')
# #%%

#%%
def chat_test(question,re_question):
    result = process_documents_and_question(question,'KoBERT_vector_store','jamodict')
    entities = json.loads(result)
    json_response = generate_response(entities)
    parsed_response = json.loads(json_response)
    re_result = query_reprocess(re_question,'KoBERT_vector_store','jamodict', entities)
    re_entities = json.loads(re_result)
    json_response = generate_response(re_entities)
    re_parsed_response = json.loads(json_response)
    return parsed_response, re_parsed_response
#%%
question = "데드풀 토요일 5시에 보고 싶어"
re_question = "강남에서 보고싶어"
#%%
print(chat_test(question,re_question))
#%%
answer_key = [
    ["울버린 이번 주 토요일 5시에 보고 싶어", "장소 누락, {영화 : 포함, 장소: 없음, 시간 포함, 날짜 포함}", "강남에서 보고 싶어.", "데드풀과 울버린"],
    ["늘봄가든 내일 저녁에 볼 수 있을까?", "시간, 장소 누락, {영화 : 포함, 장소: 없음, 시간 : 없음, 날짜 포함}", "강남에서 저녁 7시에 보고 싶어.", "늘봄가든"],
    ["빅토리 오늘 서울 연수구에서 어디서 상영하나요?", "시간 누락, {영화 : 포함, 장소: 포함, 시간 : 없음, 날짜 포함}", "오후 2시에 보고 싶어.", "빅토리"],
    ["세븐틴 투어 일요일 3시에 볼 수 있어?", "장소 누락, {영화 : 포함, 장소: 없음, 시간 포함, 날짜 포함}", "홍대에서 보고 싶어.", "세븐틴 투어 ‘팔로우’ 어게인 투 시네마"],
    ["코난 이번 주말에 부산 부산대 근처에서 상영하는 곳 있어?", "시간 누락, {영화 : 포함, 장소: 포함, 시간 : 없음, 날짜 포함}", "오후 4시에 보고 싶어.", "명탐정 코난: 100만 달러의 펜타그램"],
    ["에이리언 오늘 저녁에 대구 동성로에서 상영하는 곳 있나요?", "완전한 질문, {영화 : 포함, 장소: 포함, 시간 포함, 날짜 포함}", "답변 필요 없음.", "에이리언: 로물루스"],
    ["토끼 이번 주 토요일 오후 2시에 보고 싶어", "장소 누락, {영화 : 포함, 장소: 없음, 시간 포함, 날짜 포함}", "서초구에서 보고 싶어.", "토끼는 어디로 갔나요?"],
    ["쥬라기캅스 내일 오전 11시에 인천 연수구에서 어디서 볼 수 있나요?", "완전한 질문, {영화 : 포함, 장소: 포함, 시간 포함, 날짜 포함}", "답변 필요 없음.", "쥬라기캅스 극장판: 전설의 고대생물을 찾아라"],
    ["행복의 나라 오늘 오후 5시에 상영하나요?", "장소 누락, {영화 : 포함, 장소: 없음, 시간 포함, 날짜 포함}", "광화문에서 보고 싶어.", "행복의 나라"],
    ["슈퍼배드 이번 주 금요일에 광주 충장로에서 보고 싶어", "시간 누락, {영화 : 포함, 장소: 포함, 시간 : 없음, 날짜 포함}", "오후 6시에 보고 싶어.", "슈퍼배드 4"],
    ["이준호 콘서트 다음 주 화요일 7시에 대전 둔산동에서 보고 싶어", "완전한 질문, {영화 : 포함, 장소: 포함, 시간 포함, 날짜 포함}", "답변 필요 없음.", "이준호 콘서트 : 다시 만나는 날"],
    ["사랑의 하츄핑 이번 주 목요일 수원 영통구에서 볼 수 있어?", "시간 누락, {영화 : 포함, 장소: 포함, 시간 : 없음, 날짜 포함}", "오후 3시에 보고 싶어.", "사랑의 하츄핑"],
    ["우마무스메 주말에 부산 해운대에서 볼 수 있는 시간 있나요?", "시간 누락, {영화 : 포함, 장소: 포함, 시간 : 없음, 날짜 포함}", "오전 10시에 보고 싶어.", "우마무스메 프리티 더비 새로운 시대의 문"],
    ["옥토넛 오늘 오후에 서울 강남구에서 어디서 상영해?", "시간 누락, {영화 : 포함, 장소: 포함, 시간 : 없음, 날짜 포함}", "오후 2시에 보고 싶어.", "바다 탐험대 옥토넛 어보브 앤 비욘드 : 바다가 위험해"],
    ["이매지너리 다음 주 월요일 제주도 서귀포에서 상영하나요?", "시간 누락, {영화 : 포함, 장소: 포함, 시간 : 없음, 날짜 포함}", "오후 1시에 보고 싶어.", "이매지너리"],
    ["2023 영탁 콘서트 이번 주 일요일 오후 5시에 상영하나요?", "장소 누락, {영화 : 포함, 장소: 없음, 시간 포함, 날짜 포함}", "대전에서 보고 싶어.", "2023 영탁 단독 콘서트 : 탁쇼2"],
    ["헬로카봇 올스타 주말에 대전 둔산동에서 보고 싶어", "시간, 날짜 누락, {영화 : 포함, 장소: 포함, 시간 : 없음, 날짜 없음}", "오후 3시에 보고 싶어.", "헬로카봇 올스타 스페셜"],
    ["탈출 프로젝트 오늘 저녁 9시에 상영하나요?", "장소 누락, {영화 : 포함, 장소: 없음, 시간 포함, 날짜 포함}", "인천에서 보고 싶어.", "탈출: 프로젝트 사일런스"],
    ["봇치 더 록 이번 주 금요일 오후 4시에 서울 강남구에서 상영하는 곳 있나요?", "완전한 질문, {영화 : 포함, 장소: 포함, 시간 포함, 날짜 포함}", "답변 필요 없음.", "극장총집편 봇치 더 록! 전편"],
    ["도라에몽 다음 주 수요일 강남에서 보고 싶어", "시간 누락, {영화 : 포함, 장소: 포함, 시간 : 없음, 날짜 포함}", "오후 3시에 보고 싶어.", "극장판 도라에몽: 진구의 지구 교향곡"],
    ["스파이더맨 주말에 서울 홍대에서 상영하는 곳 있나요?", "완전한 질문, {영화 : 없음, 장소: 포함, 시간 포함, 날짜 포함}", "답변 필요 없음.", "스파이더맨 (예시)"],
    ["어벤져스 다음 주 목요일 부산 서면에서 상영하나요?", "시간 누락, {영화 : 없음, 장소: 포함, 시간 없음, 날짜 포함}", "오후 5시에 보고 싶어.", "어벤져스 (예시)"],
    ["해리포터 금요일 저녁 8시에 볼 수 있는 곳?", "완전한 질문, {영화 : 없음, 장소: 없음, 시간 포함, 날짜 포함}", "답변 필요 없음.", "해리포터 (예시)"],
    ["인셉션 오늘 저녁에 강남 신촌에서 상영하나요?", "완전한 질문, {영화 : 없음, 장소: 포함, 시간 포함, 날짜 포함}", "답변 필요 없음.", "인셉션 (예시)"],
    ["아이언맨 3 오늘 오후 6시에 보고 싶어", "완전한 질문, {영화 : 없음, 장소: 없음, 시간 포함, 날짜 포함}", "답변 필요 없음.", "아이언맨 3 (예시)"],
    ["겨울왕국 내일 오전에 대구 수성구에서 볼 수 있는 곳?", "시간 누락, {영화 : 없음, 장소: 포함, 시간 없음, 날짜 포함}", "오전 9시에 보고 싶어.", "겨울왕국 (예시)"],
    ["토이스토리 오후 3시에 상영하는 곳 있나요?", "날짜 누락, {영화 : 없음, 장소: 없음, 시간 : 포함, 날짜 없음}", "내일 보고 싶어.", "토이스토리 (예시)"],
    ["라라랜드 다음 주 화요일 오후에 서울 서울대 근처에서 상영하나요?", "시간 누락, {영화 : 없음, 장소: 포함, 시간 없음, 날짜 포함}", "오후 4시에 보고 싶어.", "라라랜드 (예시)"],
    ["타이타닉 오늘 오후 2시에 부산 해운대에서 어디서 볼 수 있나요?", "완전한 질문, {영화 : 없음, 장소: 포함, 시간 포함, 날짜 포함}", "답변 필요 없음.", "타이타닉 (예시)"],
    ["퍼시픽림 오늘 밤 9시에 볼 수 있는 곳 있나요?", "장소 누락, {영화 : 없음, 장소: 없음, 시간 포함, 날짜 포함}", "홍대에서 보고 싶어.", "퍼시픽림 (예시)"]
]
for question_and_answer in answer_key:
    question, requestion = question_and_answer[0], question_and_answer[2]
    chat_test_answers = chat_test(question,re_question)
    answer, final_answer = chat_test_answers[0], chat_test_answers[1]
#%%
question_and_answer = ["울버린 이번 주 토요일 5시에 보고 싶어", "장소 누락, {영화 : 포함, 장소: 없음, 시간 포함, 날짜 포함}", "강남에서 보고 싶어.", "데드풀과 울버린"]
question, requestion = question_and_answer[0], question_and_answer[2]
chat_test_answers = chat_test(question,re_question)
answer, final_answer = chat_test_answers[0], chat_test_answers[1]
print(question, requestion, chat_test_answers, final_answer)